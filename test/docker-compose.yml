version: '3.8'

services:
  ssh-server:
    build: .
    container_name: ssh-test
    ports:
      - "2222:22"
    volumes:
      - ./file:/etc/ssh
      - ./authorized_keys:/authorized_keys
    
    command: >
        sh -c "
        if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N ''; fi &&
        if [ ! -f /etc/ssh/ssh_host_ecdsa_key ]; then ssh-keygen -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key -N ''; fi &&
        if [ ! -f /etc/ssh/ssh_host_ed25519_key ]; then ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ''; fi &&

        sed -i 's/#LogLevel INFO/LogLevel DEBUG/' /etc/ssh/sshd_config &&

        # Ensure docker user exists
        id -u docker &>/dev/null || useradd -m -s /bin/bash docker &&

        mkdir -p /home/docker/.ssh &&
        cp /authorized_keys /home/docker/.ssh/authorized_keys &&
        chown -R docker:docker /home/docker/.ssh &&
        chmod 700 /home/docker/.ssh &&
        chmod 600 /home/docker/.ssh/authorized_keys &&

        /usr/sbin/sshd -D
        "